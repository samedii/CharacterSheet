<!DOCTYPE html>
<html>

<head>

    <title>Character Sheet</title>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="style.css" />

    <!-- Include AngularJS from Google's CDN -->

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular-resource.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular-animate.min.js"></script>

</head>

<body ng-app="Sheet" ng-controller="SheetCtrl">
    <input storage="json" type="hidden" value='{
                "characteristics": [
                    {"name":"Fysik", "value":3, "required": true},
                    {"name":"Psyke", "value":3, "required": true},
                    {"name":"Styrka", "value":3, "required": true},
                    {"name":"Smidighet", "value":3, "required": true},
                    {"name":"Intelligens", "value":3, "required": true},
                    {"name":"Perception", "value":3, "required": true},
                    {"name":"Karisma", "value":3, "required": true},
                    {"name":"", "value":0, "required": false}
                    ],
                "bodyparts": [
                    {"name":"Huvud", "hit": 1, "armor": "", "notes": ""},
                    {"name":"Höger arm", "hit": 2, "armor": "", "notes": ""},
                    {"name":"Vänster arm", "hit": 3, "armor": "", "notes": ""},
                    {"name":"Torso", "hit": 4, "armor": "", "notes": ""},
                    {"name":"Höger ben", "hit": 5, "armor": "", "notes": ""},
                    {"name":"Vänster ben", "hit": 6, "armor": "", "notes": ""}
                    ],
                "stress": [
                    {"name":"light1", "value":0},
                    {"name":"light2", "value":0},
                    {"name":"light3", "value":0},
                    {"name":"moderate1", "value":0},
                    {"name":"moderate2", "value":0},
                    {"name":"moderate3", "value":0},
                    {"name":"serious", "value":0},
                    {"name":"deadly", "value":0},
                    {"name":"dead", "value":0}
                    ]
                }' ng-model="state">
    <div id="top" resizes-to-fit-bg clean></div>
    <div id="bot"></div>
    <script type="text/javascript">
    angular.module("Sheet", ["ngAnimate"])
        .run(function() {
            var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;

            if (!is_chrome) {
                alert("Denna sida är byggd och testad på Chrome och kan se förskräcklig ut i andra läsare. Fortsätt på egen risk...");
            }

            window.onbeforeunload = function(e) {
                var message = "Kom du ihåg att spara? Ctrl+S",
                    e = e || window.event;
                // For IE and Firefox
                if (e) {
                    e.returnValue = message;
                }

                // For Safari
                return message;
            };

            window.URL = window.URL || window.webkitURL;

            window.createBlob = function createBlob() {
                var markup = document.documentElement.innerHTML;

                var blob = new Blob([markup], {
                    type: 'text/html'
                });

                return window.URL.createObjectURL(blob);
            };

            window.saveData = function() {
                var a = document.getElementById("save");
                a.href = createBlob();
                a.click();
                var url = a.href;
                window.URL.revokeObjectURL(url);
            };

            var isCtrl = false;
            document.onkeyup = function(e) {
                if (e.keyCode == 17) isCtrl = false;
            }

            document.onkeydown = function(e) {
                if (e.keyCode == 17) isCtrl = true;
                if (e.keyCode == 83 && isCtrl == true) {
                    //run code for CTRL+S -- ie, save!
                    saveData();
                    return false;
                }
            }

        })
        .controller("SheetCtrl", [
            "$scope",
            function($scope) {

                $scope.constitution = function() {
                    return $scope.state.characteristics[0].value;
                };
                $scope.willpower = function() {
                    return $scope.state.characteristics[1].value;
                };

                $scope.totalArmor = function() {
                    var sum = 0;
                    angular.forEach($scope.bodyparts, function(part, index) {
                        var armor = parseInt(part.armor);
                        if (armor && !isNaN(armor))
                        //sum += armor * (parseInt(part.hit.to) - parseInt(part.hit.from) + 1);
                            sum += armor;
                    });
                    return sum;
                };

                $scope.averageArmor = function() {
                    return Math.round($scope.totalArmor() / 7);
                };

                $scope.light = function() {
                    return Math.floor($scope.constitution() / 2) + 1;
                };

                $scope.moderate = function() {
                    return Math.ceil($scope.constitution() / 2);
                };

            }
        ])
        .filter("round", function() {
            return function(input) {
                return Math.round(input);
            };
        })
        .directive("resizes", [
            "$interval",
            "$timeout",
            function($interval, $timeout) {
                return {
                    link: function(scope, element) {
                        var e = element[0];

                        function setWidth() {
                            element.css("width", e.scrollWidth + "px");
                            element.css("display", "initial");
                        }

                        function resetWidth() {
                            var cachedOffsetWidth = e.offsetWidth;
                            element.css("width", "auto");
                            element.css("display", "none");

                            var time = 0;

                            function helper() {

                                if (e.offsetWidth !== cachedOffsetWidth) {

                                    cachedOffsetWidth = e.offsetWidth;
                                    setWidth();
                                } else if (e.scrollWidth > e.offsetWidth) {

                                    cachedOffsetWidth = e.offsetWidth;
                                    setWidth();
                                }

                                if (time < 5000)
                                    $timeout(helper, time = time * 2);
                            }

                            $timeout(helper, time++);
                        };

                        resetWidth();

                        element.on("input", function() {
                            setWidth();
                        });

                        element.on("blur", function() {
                            resetWidth();
                        });
                    }
                };
            }
        ])
        .directive("textarea", [
            "$interval",
            "$timeout",
            function($interval, $timeout) {
                return {
                    restrict: "E",
                    link: function(scope, element) {
                        var e = element[0];

                        function setHeight() {
                            var paddingTop = parseInt(window.getComputedStyle(e, null).getPropertyValue('padding-top'));
                            var paddingBottom = parseInt(window.getComputedStyle(e, null).getPropertyValue('padding-bottom'));
                            if (!paddingTop || isNaN(paddingTop))
                                paddingTop = 0;
                            if (!paddingBottom || isNaN(paddingTop))
                                paddingTop = 0;
                            element.css("height", (e.scrollHeight - paddingTop - paddingBottom) + "px");
                            element.css("display", "initial");

                            scope.resizeBg();
                        }

                        function resetHeight() {
                            var cachedOffsetHeight = e.offsetHeight;
                            element.css("height", "auto");
                            element.css("display", "none");

                            var time = 0;

                            function helper() {

                                if (e.offsetHeight !== cachedOffsetHeight) {
                                    cachedOffsetHeight = e.offsetHeight;
                                    setHeight();
                                } else if (e.scrollHeight > e.offsetHeight) {
                                    cachedOffsetHeight = e.offsetHeight;
                                    setHeight();
                                }

                                if (time < 5000)
                                    $timeout(helper, time = time * 2);
                            }

                            $timeout(helper, time++);
                        };

                        resetHeight();

                        element.on("input", function() {
                            setHeight();
                        });

                        element.on("blur", function() {
                            resetHeight();
                        });

                    }
                };
            }
        ])
        .constant("topHeight", 957)
        .constant("repeatHeight", 213)
        .directive("resizesToFitBg", [
            "topHeight",
            "repeatHeight",
            function(topHeight, repeatHeight) {
                return {
                    link: function(scope, element) {
                        var e = element[0];

                        function resize() {

                            var height = e.scrollHeight;

                            if (height <= topHeight) {
                                e.style.minHeight = (topHeight + repeatHeight) + "px";
                            } else {
                                var extraHeight = height - topHeight;
                                var extra = extraHeight / repeatHeight;
                                e.style.minHeight = (topHeight + Math.ceil(extra) * repeatHeight) + "px";
                            }
                        }

                        resize();

                        scope.resizeBg = resize;
                    }
                }
            }
        ])
        .directive("characteristic", [
            "$timeout",
            function($timeout) {
                return {
                    restrict: "A",
                    template: [
                        '<label ng-mouseover="startShowCtrl()">',
                        '<input type="text" ng-model="skill.name" ng-focus="focusedSkillName($last)" />',
                        '<span class="dotsContainer">',
                        '<span class="dots" ng-style="{\'width\': (skill.value*11)+\'px\'}">',
                        '<div class="ctrl" ng-show="showCtrl">',
                        '<div style="position: relative">',
                        '<input class="plus" type="button" value="+" ng-click="skill.value=skill.value+1" ng-disabled="skill.value>=5 || !showCtrl" />',
                        '<input class="minus" type="button" value="-" ng-click="skill.value=skill.value-1" ng-disabled="skill.value<=0  || !showCtrl" />',
                        '<input class="cross" type="button" value="x" ng-click="state.characteristics.splice($index,1)" ng-disabled="skill.required || $last" ng-hide="skill.required || $last" />',
                        '</div>',
                        '</div>',
                        '<input type="hidden" ng-model="skill.value" />',
                        '</span>',
                        '</span>',
                        '</label>'
                    ].join('\n'),
                    //scope: true,
                    link: function(scope, element, attrs) {

                        var timer;
                        scope.startShowCtrl = function() {

                            $timeout.cancel(timer);
                            scope.showCtrl = true;

                            timer = $timeout(function() {
                                scope.showCtrl = false;
                            }, 2000);
                        };

                        scope.focusedSkillName = function(isLast) {
                            if (isLast) {
                                scope.state.characteristics.push({
                                    "name": "",
                                    "value": 0,
                                    "required": false
                                });
                                $timeout(scope.resizeBg, 10);
                            }
                        };
                    },

                }
            }
        ])
        .directive("storage", [

            function() {
                return {
                    link: function(scope, element, attrs) {
                        var e = element[0];

                        switch (attrs.storage) {
                            case "json":
                                scope[attrs.ngModel] = angular.fromJson(e.defaultValue);
                                scope.$watch(attrs.ngModel, function() {
                                    e.defaultValue = angular.toJson(scope[attrs.ngModel]);
                                }, true);
                                break;
                            case "number":
                                scope[attrs.ngModel] = parseInt(e.defaultValue);
                                scope.$watch(attrs.ngModel, function() {
                                    e.defaultValue = scope[attrs.ngModel].toString();
                                });
                                break;
                            case "text":
                            default:
                                scope[attrs.ngModel] = e.defaultValue;
                                scope.$watch(attrs.ngModel, function() {
                                    e.defaultValue = scope[attrs.ngModel];
                                });
                                break;
                        }
                    }
                }
            }
        ])
        .directive('ngColspan', [
            function() {
                return {
                    scope: {
                        'colspan': '&ngColspan'
                    },
                    link: function(scope, element, attrs) {
                        scope.$watch('colspan()', function() {
                            element.attr('colspan', scope.colspan());
                        });
                    }
                }
            }
        ])
        .filter('stressFilter', [
            function() {
                return function(stress, light, moderate) {

                    return stress.filter(function(wound, i) {
                        if(light <= i && i < 3)
                            return false;
                        if(3+moderate <= i && i < 6)
                            return false;
                        return true;
                    });
                };
            }])
        .directive('clean', [

            function() {
                return {
                    compile: function compile(element, attrs, transclude) {
                        element.html('<a id="save" href="failed to create blob" download="{{state.characterName}}.htm" style="display:none">Spara</a>\
                            <a id="saveState" href="failed to create state blob" download="{{state.characterName}}-State.json" style="display:none">Spara state</a>\
        <div style="padding:150px 150px 0 150px; height: 100%">\
            <div style="position:relative; height: 120px">\
            <h1>\
                    <input resizes type="text" placeholder="Namn" style="min-width: 320px" ng-model="state.characterName" />\
                </h1>\
                <label style="font-size: 14px; position: absolute; bottom: 0; right: 0;">Spelare:\
                    <input resizes type="text" placeholder="Namn" value="Richard Hermanson" style="min-width: 65px; font-size: 60px" ng-model="state.playerName" />\
                </label>\
            </div>\
            <div>\
                <h2 style="margin: -30px 0 0 0">Beskrivning</h2>\
                <textarea style="margin: 0 0 20px 0" placeholder="Karaktärsbeskrivning" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="state.characterDescription"></textarea>\
            </div>\
            <div style="clear: both">\
                <div class="characteristics" style="width: 40%; float: left">\
                    <h2 style="margin-bottom:4px">Karaktärsdrag</h2>\
                    <div ng-repeat="skill in state.characteristics">\
                        <div characteristic style="height:36px"></div>\
                    </div>\
                </div>\
            </div>\
            <div style="width: 60%; float: right; text-align: right">\
                <h2>Äventyrspoäng</h2>\
                <label>Totalt\
                    <input resizes type="text" placeholder="" style="min-width: 60px" ng-model="state.totalExp" />\
                </label>\
                <label style="text-align: right">Nya\
                    <input resizes type="text" placeholder="" style="min-width: 16px" ng-model="state.newExp" />\
                </label>\
                <div class="health">\
                    <div style="line-height: 22px">\
                        <h2 style="width: 137px">Kropp</h2>\
                        <h3 style="width: 27px; text-align: left">rv</h3>\
                        <h3 style="width: 120px; text-align: right">anteckningar</h3>\
                    </div>\
\
                    <div ng-repeat="part in state.bodyparts" style="font-size: 40px; line-height: 30px">\
                        <div style="width: 42px; text-align: center">{{part.hit}}</div>\
                        <div style="width: 95px">{{part.name}}</div>\
                        <div style="width: 21px; height: 30px; text-align: center">\
                            <input style="width: 20px; height: 30px; text-align: left; position: relative; top: -4px" type="text" ng-model="part.armor" />\
                        </div>\
                        <div style="width: 122px; height: 30px; text-align: left">\
                            <input style="width: 100%; height: 30px; text-align: right; position: relative; top: -4px" type="text" ng-model="part.notes" />\
                        </div>\
                    </div>\
                </div>\
                <div style="margin: 10px 0 10px 30px; text-align: left; position: relative">\
                    <h2 style="text-align: left; border-bottom: 1px solid white; margin-bottom: 4px">Vapen och sköldar</h2>\
                    <textarea style="width: 70%" placeholder="Jag är obeväpnad!" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="state.weapons"></textarea>\
                    <textarea style="width: 20%; text-align: right; position: absolute; right: 0" placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="state.weaponStats"></textarea>\
                </div>\
                <div style="margin: 10px 0 10px 30px; text-align: left">\
                    <h2 style="text-align: left; border-bottom: 1px solid white; margin-bottom: 4px">Utrustning</h2>\
                    <textarea placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="state.equipment"></textarea>\
                </div>\
            </div>\
            <div class="stress" style="margin: 10px 0 10px 0px; width: 100%; display: inline-block">\
                <h2>Stress</h2>\
                <table style="border-top: 1px solid #fff">\
                    <tr>\
                        <th style="width: 14%">Skada</th>\
                        <td ng-colspan="light()">3</td>\
                        <td ng-colspan="moderate()">5</td>\
                        <td>7</td>\
                        <td>10</td>\
                        <td>15</td>\
                    </tr>\
                    <tr>\
                        <th>Skadetyp</th>\
                        <td ng-colspan="light()">L&auml;tt</td>\
                        <td ng-colspan="moderate()">Medel</td>\
                        <td>Allvarlig</td>\
                        <td>D&ouml;dlig</td>\
                        <td>D&ouml;d</td>\
                    </tr>\
                    <tr>\
                        <th>Mod.</th>\
                        <td ng-colspan="light()"></td>\
                        <td ng-colspan="moderate()">-1</td>\
                        <td>-2</td>\
                        <td></td>\
                        <td></td>\
                    </tr>\
                    <tr>\
                        <th>Stress</th>\
                        <td ng-repeat="wound in state.stress | stressFilter:light():moderate()"><div class="squared"><input ng-model="wound.value" type="checkbox" id="{{wound.name}}"/><label for="{{wound.name}}"></label></div></td>\
                    </tr>\
                </table>\
            </div>\
            <div style="width: 100%; display: inline-block">\
                <h2>Journal</h2>\
                <textarea placeholder="Min berättelse börjar här..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="state.journal"></textarea>\
            </div>\
        </div>\
        <div id="repeat"></div>\
    </div>');
                    }
                }
            }
        ]);
    </script>

</body>

</html>